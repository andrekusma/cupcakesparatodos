<!DOCTYPE html>
const adminTable = $('adminTable');
$('btnAdd').addEventListener('click', onAdd);


async function onAdd(){
const nome = $('newNome').value.trim();
const preco = parseFloat(($('newPreco').value||'0').replace(',','.'));
const estoque = parseInt($('newEstoque').value||'0');
const image_url = $('newImg').value.trim();
if(!nome || isNaN(preco)) return alert('Preencha nome e preÃ§o');
try{
const created = await apiCreate({ nome, descricao:'', preco_cents: Math.round(preco*100), estoque, image_url });
$('newNome').value = $('newPreco').value = $('newEstoque').value = $('newImg').value = '';
await loadList(); renderAdmin();
}catch(e){ alert('Falha ao adicionar'); console.error(e) }
}


function renderAdmin(){
adminTable.innerHTML = '';
cupcakes.forEach(c=>{
const tr = document.createElement('tr');
tr.innerHTML = `
<td>#${c.id}</td>
<td><img src="${imgOrPlaceholder(c.image_url,c.nome)}" class="thumb" style="width:58px;height:58px" onerror="this.src='${placeholder(c.nome)}'"/></td>
<td><input class="input" value="${escAttr(c.nome)}" onchange="editField(${c.id},'nome',this.value)"/></td>
<td><input class="input" type="number" step="0.01" value="${(c.preco_cents/100).toFixed(2)}" onchange="editField(${c.id},'preco',this.value)"/></td>
<td><input class="input" type="number" min="0" value="${c.estoque||0}" onchange="editField(${c.id},'estoque',this.value)"/></td>
<td class="row" style="gap:8px">
<input class="input" style="min-width:220px" placeholder="URL imagem (https://...)" value="${escAttr(c.image_url||'')}" onchange="editField(${c.id},'image_url',this.value)"/>
<button class="btn ok" onclick="saveRow(${c.id})">Salvar</button>
<button class="btn warn" onclick="delRow(${c.id})">Excluir</button>
</td>`;
adminTable.appendChild(tr);
});
}


const edits = new Map();
function editField(id, field, val){
const cur = edits.get(id)||{};
if(field==='preco'){ cur.preco_cents = Math.round(parseFloat(String(val).replace(',','.'))*100)||0; }
else if(field==='estoque'){ cur.estoque = parseInt(val||'0') }
else if(field==='image_url'){ cur.image_url = String(val).trim() || null }
else { cur.nome = val }
edits.set(id, cur);
}
async function saveRow(id){
try{
const payload = edits.get(id)||{}; if(Object.keys(payload).length===0) return;
await apiUpdate(id, payload);
edits.delete(id);
await loadList(); renderAdmin();
}catch(e){ alert('Falha ao salvar'); console.error(e) }
}
async function delRow(id){
if(!confirm('Excluir cupcake #' + id + '?')) return;
try{ await apiDelete(id); await loadList(); renderAdmin(); }
catch(e){ alert('Falha ao excluir'); console.error(e) }
}


function esc(s=''){ return String(s).replace(/[&<>]/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m])) }
function escAttr(s=''){ return esc(s).replace(/"/g,'&quot;') }
function placeholder(seed='Cupcake'){ const n=Math.abs(hash(seed))%1000; return `https://picsum.photos/seed/${n}/600/400`; }
function hash(str){ let h=0; for(let i=0;i<str.length;i++) h=(h<<5)-h+str.charCodeAt(i)|0; return h }
function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms) } }


(async function(){ await loadList(); renderCart(); renderFavs(); renderHistory(); })();
</script>
</body>
</html>