<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cupcakes para Todos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.5rem 1rem;border-radius:.75rem;font-weight:600;cursor:pointer;transition:all .15s ease;user-select:none;box-shadow:0 2px 8px rgba(16,24,40,.08);border:1px solid transparent}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-primary{background:#e84f96;color:#fff;border-color:#e84f96}
    .btn-primary:hover{background:#d4317d;border-color:#d4317d;transform:translateY(-1px)}
    .btn-secondary{background:#fff;color:#111827;border-color:#e5e7eb}
    .btn-secondary:hover{background:#f9fafb}
    .btn-danger{background:#fee2e2;color:#b91c1c;border-color:#fecaca}
    .btn-danger:hover{background:#fecaca}
    .field{width:100%;border:1px solid #e5e7eb;border-radius:.75rem;padding:.5rem .75rem;font-size:.9rem;background:#fff;outline:none}
    .field:focus{border-color:#e84f96;box-shadow:0 0 0 3px rgba(232,79,150,.15)}
    .glass{background:rgba(255,255,255,.8);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.6);box-shadow:0 8px 30px rgba(16,24,40,.06)}
    .card{border:1px solid #e5e7eb;background:#fff;border-radius:1rem;box-shadow:0 8px 30px rgba(16,24,40,.06);overflow:hidden}
    .chip{display:inline-flex;align-items:center;gap:.25rem;background:#e7f5ef;color:#136f4e;font-weight:700;font-size:.7rem;border-radius:999px;padding:.25rem .5rem}
    .skeleton{background:linear-gradient(90deg,#f6f7f8 0%,#edeef1 50%,#f6f7f8 100%);background-size:200% 100%;animation:shine 1.2s infinite}
    @keyframes shine{to{background-position:-200% 0}}
    .icon-btn{position:relative}
    .badge{position:absolute;top:-6px;right:-6px;background:#111827;color:#fff;border-radius:999px;font-size:.7rem;font-weight:700;min-width:1.25rem;height:1.25rem;display:grid;place-items:center;padding:0 .25rem}
    .menu{position:absolute;right:0;top:100%;margin-top:.5rem;background:#fff;border:1px solid #e5e7eb;border-radius:.75rem;box-shadow:0 10px 30px rgba(16,24,40,.12);overflow:hidden;min-width:220px}
    .menu a, .menu button{display:flex;width:100%;text-align:left;padding:.6rem .9rem;font-weight:500}
    .menu a:hover,.menu button:hover{background:#f9fafb}
    .pill{display:inline-block;padding:.15rem .5rem;border-radius:999px;font-size:.7rem;font-weight:700}
    .pill-pix{background:#e0f2f1;color:#0f766e}
    .pill-card{background:#e0e7ff;color:#3730a3}
    .muted{color:#6b7280}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-white to-pink-50 text-gray-900">

  <header class="sticky top-0 z-50 bg-white/70 backdrop-blur border-b border-gray-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <!-- √çcone cupcake SVG -->
        <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" aria-label="Cupcakes para Todos" class="h-10 w-10 select-none" style="display:block">
          <defs>
            <linearGradient id="cup-frost" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="#ffd6e7"/>
              <stop offset="100%" stop-color="#ffa4c8"/>
            </linearGradient>
            <linearGradient id="cup-wrap" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="#f472b6"/>
              <stop offset="100%" stop-color="#db2777"/>
            </linearGradient>
          </defs>
          <ellipse cx="24" cy="41" rx="12" ry="3.5" fill="rgba(0,0,0,0.10)"/>
          <path d="M12 22c0-4.5 4.5-7.5 9-6.3C22 12.5 25.5 10 29 10c4.5 0 8 3.5 8 8 2.5.7 4 2.7 4 5 0 3.3-3 6-6.8 6H18.8C14.7 29 12 25.8 12 22z" fill="url(#cup-frost)"/>
          <circle cx="21" cy="17.5" r="1.2" fill="#34d399"/>
          <circle cx="26" cy="14.5" r="1.1" fill="#60a5fa"/>
          <circle cx="31" cy="18.5" r="1.2" fill="#f59e0b"/>
          <circle cx="28.5" cy="22" r="1.1" fill="#a78bfa"/>
          <circle cx="32.5" cy="12.2" r="2" fill="#ef4444"/>
          <path d="M32.5 10c-1.5-1.8-1.2-3.6.8-5" stroke="#ef4444" stroke-width="1.2" fill="none" stroke-linecap="round" opacity=".7"/>
          <path d="M16 29h16l-2.2 10.5a2.5 2.5 0 0 1-2.4 1.9h-6.8a2.5 2.5 0 0 1-2.4-1.9L16 29z" fill="url(#cup-wrap)"/>
          <path d="M18.2 29l2 12M22 29l1 12M26 29l-1 12M29.8 29l-2 12" stroke="rgba(255,255,255,0.5)" stroke-width="1.2" stroke-linecap="round"/>
          <path d="M17 21c0-2.6 2.6-4.4 5.1-3.7" stroke="#fff" stroke-opacity=".6" stroke-width="2" stroke-linecap="round"/>
          <path d="M34 29c2.8 0 5.8-2.7 5.8-6 0-2.3-1.5-4.3-4-5 0-3.3-2.7-6-6-6-1.3 0-2.6.4-3.7 1.1 3.2.6 5.6 3.4 5.6 6.7 0 3.7-3 6.8-6.8 6.8H34z" fill="rgba(0,0,0,0.05)"/>
        </svg>
        <h1 class="text-lg font-extrabold leading-tight select-none">Cupcakes para Todos</h1>
      </div>
      <nav class="flex items-center gap-2 relative">
        <button id="openSettings" class="btn btn-secondary hidden" title="Configurar API">Configura√ß√µes</button>
        <button id="openRegister" class="btn btn-secondary">Cadastrar</button>
        <button id="openAuth" class="btn btn-primary">Entrar</button>
        <button id="btnLogout" class="btn btn-secondary hidden">Sair</button>
        <button id="openCart" class="btn btn-secondary icon-btn" title="Carrinho">üõí
          <span id="cartQty" class="badge hidden">0</span>
        </button>
        <div id="userMenuWrap" class="relative hidden">
          <button id="userMenuBtn" class="btn btn-secondary"></button>
          <div id="userMenu" class="menu hidden">
            <button id="openProfile" type="button">Perfil</button>
            <button id="openOrders" type="button">Meus pedidos</button>
            <button id="logoutFromMenu" type="button">Sair</button>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <section class="max-w-6xl mx-auto px-4 mt-6">
    <div class="glass rounded-2xl p-5">
      <div class="flex flex-col md:flex-row md:items-end gap-3">
        <div class="flex-1">
          <label class="text-sm font-medium text-gray-700" for="search">Buscar cupcakes</label>
          <input id="search" class="field" placeholder="Ex.: Chocolate, Red Velvet, Baunilha‚Ä¶" />
        </div>
        <div class="flex gap-2">
          <button id="btnClear" class="btn btn-secondary">Limpar</button>
          <button id="btnRefresh" class="btn btn-primary">Atualizar lista</button>
        </div>
      </div>
    </div>
  </section>

  <main class="max-w-6xl mx-auto px-4 py-6 grid gap-6 md:grid-cols-3">
    <section class="md:col-span-2">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-bold">Cat√°logo</h2>
        <span id="countChip" class="chip">0 itens</span>
      </div>
      <div id="grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" aria-live="polite"></div>
      <p id="empty" class="hidden text-center text-gray-500 py-8">Nenhum cupcake encontrado.</p>
    </section>

    <aside id="adminPanel" class="card p-5 h-fit hidden">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-lg font-bold">√Årea administrativa</h3>
        <span class="chip">Admin</span>
      </div>
      <p class="text-sm text-gray-600 mb-3">Cadastro com imagem PNG/JPEG. Campo do upload: <b>image</b>.</p>
      <form id="formCreate" class="space-y-3">
        <div>
          <label class="text-sm font-medium text-gray-700" for="name">Nome</label>
          <input id="name" class="field" required placeholder="Ex.: Red Velvet" />
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700" for="description">Descri√ß√£o</label>
          <textarea id="description" class="field" required placeholder="Breve descri√ß√£o"></textarea>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm font-medium text-gray-700" for="price">Pre√ßo (R$)</label>
            <input id="price" type="number" step="0.01" min="0" class="field" required />
          </div>
          <div>
            <label class="text-sm font-medium text-gray-700" for="stock">Estoque</label>
            <input id="stock" type="number" step="1" min="0" class="field" value="0" />
          </div>
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700" for="image">Imagem (PNG/JPEG)</label>
          <div id="drop" class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center hover:bg-gray-50 transition">
            <p class="text-sm text-gray-600">Arraste a imagem aqui ou clique para selecionar</p>
            <input id="image" type="file" accept="image/png,image/jpeg" class="hidden" required />
          </div>
          <img id="preview" alt="Pr√©via" class="hidden mt-2 w-full h-40 object-cover rounded-xl border" />
        </div>
        <div class="flex gap-2">
          <button type="submit" class="btn btn-primary">Cadastrar</button>
          <button type="reset" class="btn btn-secondary">Limpar</button>
        </div>
      </form>
    </aside>
  </main>

  <dialog id="settings" class="backdrop:bg-black/30 rounded-2xl w-full max-w-lg p-0">
    <form method="dialog" class="glass p-5 rounded-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-bold">Configura√ß√µes do frontend</h3>
        <button class="btn btn-secondary" aria-label="Fechar">Fechar</button>
      </div>
      <div class="space-y-3">
        <div>
          <label class="text-sm font-medium text-gray-700" for="apiBase">API Base URL</label>
          <input id="apiBase" class="field" placeholder="https://cupcakesparatodos.onrender.com" />
        </div>
        <div class="text-xs text-gray-600">
          <ul class="list-disc ml-5">
            <li><code>POST /api/auth/login</code>, <code>POST /api/auth/register</code>, <code>GET /api/auth/me</code>, <code>PUT /api/auth/me</code>, <code>DELETE /api/auth/me</code>, <code>POST /api/auth/change-password</code></li>
            <li><code>GET /api/cupcakes</code></li>
            <li><code>POST /api/admin/cupcakes</code></li>
            <li><code>DELETE /api/admin/cupcakes/:id</code></li>
            <li><code>POST /api/orders</code>, <code>GET /api/orders/my</code></li>
          </ul>
        </div>
        <div class="flex gap-2">
          <button id="btnSaveBase" type="button" class="btn btn-primary">Salvar URL</button>
          <button id="btnPing" type="button" class="btn btn-secondary">Testar conex√£o</button>
        </div>
      </div>
    </form>
  </dialog>

  <dialog id="auth" class="backdrop:bg-black/30 rounded-2xl w-full max-w-md p-0">
    <form method="dialog" class="glass p-5 rounded-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-bold">Entrar</h3>
        <button class="btn btn-secondary" aria-label="Fechar">Fechar</button>
      </div>
      <div class="space-y-3">
        <div>
          <label class="text-sm font-medium text-gray-700" for="email">E-mail</label>
          <input id="email" type="email" required class="field" placeholder="email@exemplo.com" />
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700" for="password">Senha</label>
        <input id="password" type="password" required class="field" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
        <div class="flex gap-2">
          <button id="doLogin" type="button" class="btn btn-primary">Entrar</button>
          <button value="cancel" class="btn btn-secondary">Cancelar</button>
        </div>
        <p id="authError" class="hidden text-sm text-red-600"></p>
      </div>
    </form>
  </dialog>

  <dialog id="register" class="backdrop:bg-black/30 rounded-2xl w-full max-w-md p-0">
    <form method="dialog" class="glass p-5 rounded-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-bold">Criar conta</h3>
        <button class="btn btn-secondary" aria-label="Fechar">Fechar</button>
      </div>
      <div class="space-y-3">
        <div>
          <label class="text-sm font-medium text-gray-700" for="regNome">Nome</label>
          <input id="regNome" class="field" placeholder="Seu nome" />
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700" for="regTelefone">Telefone</label>
          <input id="regTelefone" class="field" placeholder="(00) 90000-0000" />
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700" for="regEndereco">Endere√ßo</label>
          <textarea id="regEndereco" class="field" placeholder="Rua, n√∫mero, complemento, bairro, cidade, UF"></textarea>
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700" for="regEmail">E-mail</label>
          <input id="regEmail" type="email" required class="field" placeholder="email@exemplo.com" />
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700" for="regPass">Senha</label>
          <input id="regPass" type="password" required class="field" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
        <div class="flex gap-2">
          <button id="doRegister" type="button" class="btn btn-primary">Cadastrar</button>
          <button value="cancel" class="btn btn-secondary">Cancelar</button>
        </div>
        <p id="regError" class="hidden text-sm text-red-600"></p>
      </div>
    </form>
  </dialog>

  <dialog id="profile" class="backdrop:bg-black/30 rounded-2xl w-full max-w-md p-0">
    <form method="dialog" class="glass p-5 rounded-2xl" id="profileForm">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-bold">Seu perfil</h3>
        <button class="btn btn-secondary" aria-label="Fechar">Fechar</button>
      </div>
      <div class="space-y-3">
        <div>
          <label class="text-sm font-medium text-gray-700" for="pfNome">Nome</label>
          <input id="pfNome" class="field" placeholder="Seu nome" />
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700" for="pfTelefone">Telefone</label>
          <input id="pfTelefone" class="field" placeholder="(00) 90000-0000" />
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700" for="pfEndereco">Endere√ßo</label>
          <textarea id="pfEndereco" class="field" placeholder="Rua, n√∫mero, complemento, bairro, cidade, UF"></textarea>
        </div>
      </div>
      <p id="pfError" class="hidden text-sm text-red-600 mt-2"></p>
      <div class="mt-4 flex justify-between items-center">
        <button id="btnSaveProfile" type="button" class="btn btn-primary">Salvar altera√ß√µes</button>
        <div class="flex gap-2">
          <button id="btnChangePassOpen" type="button" class="btn btn-secondary">Alterar senha</button>
          <button id="btnDeleteAccount" type="button" class="btn btn-danger">Remover conta</button>
        </div>
      </div>
    </form>
  </dialog>

  <dialog id="changePassModal" class="backdrop:bg-black/30 rounded-2xl w-full max-w-md p-0">
    <form method="dialog" class="glass p-5 rounded-2xl" id="changePassForm" novalidate>
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-bold">Alterar senha</h3>
        <button class="btn btn-secondary" aria-label="Fechar">Fechar</button>
      </div>
      <div class="space-y-3">
        <div>
          <label class="text-sm font-medium text-gray-700" for="pfCurPass">Senha atual</label>
          <input id="pfCurPass" type="password" class="field" placeholder="Senha atual">
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700" for="pfNewPass">Nova senha</label>
          <input id="pfNewPass" type="password" class="field" placeholder="Nova senha">
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700" for="pfNewPass2">Confirmar nova senha</label>
          <input id="pfNewPass2" type="password" class="field" placeholder="Confirmar nova senha">
        </div>
      </div>
      <p id="cpError" class="hidden text-sm text-red-600 mt-2"></p>
      <div class="mt-4 flex justify-end">
        <button id="btnChangePass" type="button" class="btn btn-primary">Salvar nova senha</button>
      </div>
    </form>
  </dialog>

  <dialog id="cartModal" class="backdrop:bg-black/30 rounded-2xl w-full max-w-2xl p-0">
    <form method="dialog" class="glass p-5 rounded-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-bold">Seu carrinho</h3>
        <button class="btn btn-secondary" aria-label="Fechar">Fechar</button>
      </div>
      <div id="cartItems" class="space-y-3 max-h-[50vh] overflow-auto"></div>
      <div class="mt-4 flex items-center justify-between">
        <div class="text-lg font-bold">Total: <span id="cartTotal">R$ 0,00</span></div>
        <button id="btnCheckout" type="button" class="btn btn-primary">Finalizar compra</button>
      </div>
    </form>
  </dialog>

  <dialog id="paymentModal" class="backdrop:bg-black/30 rounded-2xl w-full max-w-md p-0">
    <form method="dialog" class="glass p-5 rounded-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-bold">Forma de pagamento</h3>
        <button class="btn btn-secondary" aria-label="Fechar">Fechar</button>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <button type="button" id="payPix" class="btn btn-secondary flex-col py-6">
          <div class="text-3xl">‚ö°</div>
          <div class="text-sm font-semibold mt-1">PIX</div>
        </button>
        <button type="button" id="payCard" class="btn btn-secondary flex-col py-6">
          <div class="text-3xl">üí≥</div>
          <div class="text-sm font-semibold mt-1">Cart√£o de cr√©dito</div>
        </button>
      </div>
    </form>
  </dialog>

  <dialog id="pixModal" class="backdrop:bg-black/30 rounded-2xl w-full max-w-md p-0">
    <form method="dialog" class="glass p-5 rounded-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-bold">Pagamento via PIX</h3>
        <button class="btn btn-secondary" aria-label="Fechar">Fechar</button>
      </div>
      <p class="text-sm text-gray-700 mb-3">
        Para confirmar sua compra, transfira o valor da sua compra para nosso PIX:
        <b>cpt@cupcake.com</b>. Insira o c√≥digo da sua compra na sua transfer√™ncia.
      </p>
      <div class="card p-4 text-center">
        <div class="text-xs text-gray-600">C√≥digo da compra</div>
        <div id="pixCode" class="text-xl font-extrabold mt-1 select-all">‚Äî</div>
      </div>
      <div class="mt-4 flex justify-end">
        <button class="btn btn-primary">Ok</button>
      </div>
    </form>
  </dialog>

  <dialog id="successModal" class="backdrop:bg-black/30 rounded-2xl w-full max-w-md p-0">
    <form method="dialog" class="glass p-5 rounded-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-bold">Compra conclu√≠da</h3>
        <button class="btn btn-secondary" aria-label="Fechar">Fechar</button>
      </div>
      <p class="text-sm text-gray-700 mb-3">
        Pagamento efetuado, agradecemos a prefer√™ncia. Logo voc√™ receber√° seus deliciosos cupcakes em casa.
      </p>
      <div class="card p-4 text-center">
        <div class="text-xs text-gray-600">C√≥digo da compra</div>
        <div id="successCode" class="text-xl font-extrabold mt-1 select-all">‚Äî</div>
      </div>
      <div class="mt-4 flex justify-end">
        <button class="btn btn-primary">Ok</button>
      </div>
    </form>
  </dialog>

  <dialog id="cardModal" class="backdrop:bg-black/30 rounded-2xl w-full max-w-md p-0">
    <form method="dialog" class="glass p-5 rounded-2xl" id="cardFormEl" novalidate>
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-bold">Cart√£o de cr√©dito</h3>
        <button class="btn btn-secondary" aria-label="Fechar">Fechar</button>
      </div>
      <div class="space-y-3">
        <div>
          <label class="text-sm font-medium text-gray-700" for="ccName">Nome do portador</label>
          <input id="ccName" class="field" autocomplete="cc-name" placeholder="Nome impresso no cart√£o" required />
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700" for="ccNumber">N√∫mero do cart√£o</label>
          <input id="ccNumber" class="field" inputmode="numeric" autocomplete="cc-number" placeholder="0000 0000 0000 0000" required />
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm font-medium text-gray-700" for="ccExp">Validade (MM/AA)</label>
            <input id="ccExp" class="field" inputmode="numeric" autocomplete="cc-exp" placeholder="MM/AA" required />
          </div>
          <div>
            <label class="text-sm font-medium text-gray-700" for="ccCvc">C√≥d. verifica√ß√£o</label>
            <input id="ccCvc" class="field" inputmode="numeric" autocomplete="cc-csc" placeholder="CVC" required />
          </div>
        </div>
      </div>
      <p id="cardError" class="hidden text-sm text-red-600 mt-2"></p>
      <div class="mt-4 flex justify-end">
        <button id="btnFinishCard" type="button" class="btn btn-primary" disabled>Finalizar compra</button>
      </div>
    </form>
  </dialog>

  <dialog id="ordersModal" class="backdrop:bg-black/30 rounded-2xl w-full max-w-3xl p-0">
    <form method="dialog" class="glass p-5 rounded-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-bold">Meus pedidos</h3>
        <button class="btn btn-secondary" aria-label="Fechar">Fechar</button>
      </div>
      <div id="ordersWrap" class="space-y-3 max-h-[60vh] overflow-auto">
        <div id="ordersEmpty" class="text-center text-gray-500 hidden">Nenhum pedido encontrado.</div>
      </div>
    </form>
  </dialog>

  <div id="toast" class="fixed bottom-4 right-4 z-[60] hidden">
    <div class="rounded-xl bg-gray-900 text-white px-4 py-2 shadow" role="status"></div>
  </div>

  <script>
    const STORAGE = { base:'API_BASE_URL', token:'JWT_TOKEN', user:'AUTH_USER' };
    const getBase = () => {
      const fromQuery = new URLSearchParams(location.search).get('api');
      if (fromQuery) localStorage.setItem(STORAGE.base, String(fromQuery).replace(/\/$/, ''));
      return localStorage.getItem(STORAGE.base) || 'https://cupcakesparatodos.onrender.com';
    };
    const setBase = (v) => localStorage.setItem(STORAGE.base, String(v).replace(/\/$/, ''));
    const state = { token: localStorage.getItem(STORAGE.token) || null, user: JSON.parse(localStorage.getItem(STORAGE.user) || 'null'), items: [], filtered: [] };

    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));
    function toast(msg, ok=true){ const box = $('#toast'); box.classList.remove('hidden'); box.firstElementChild.textContent = msg; box.firstElementChild.className = `rounded-xl px-4 py-2 shadow ${ok?'bg-gray-900 text-white':'bg-red-600 text-white'}`; setTimeout(()=> box.classList.add('hidden'), 2400); }
    const isAdmin = ()=> !!(state.user && state.user.role==='admin');
    const isLogged = ()=> !!(state.token && state.user);
    const authHeader = ()=> state.token ? { Authorization:`Bearer ${state.token}` } : {};
    const currency = (n)=> Number(n||0).toLocaleString('pt-BR',{ style:'currency', currency:'BRL' });
    function fullURL(pathOrUrl){ if (!pathOrUrl) return ''; if (/^https?:\/\//i.test(pathOrUrl)) return pathOrUrl; const base = getBase(); return `${base}${pathOrUrl.startsWith('/')?'':'/'}${pathOrUrl}`; }

    function cartKey(){ const uid = state?.user?.id ?? 'guest'; return `CART_${uid}`; }
    function loadCart(){ try{return JSON.parse(localStorage.getItem(cartKey())||'[]');}catch{return[];} }
    function saveCart(arr){ localStorage.setItem(cartKey(), JSON.stringify(arr)); renderCart(); }
    function clearCart(){ localStorage.removeItem(cartKey()); renderCart(); }
    function cartQty(){ return loadCart().reduce((s,i)=> s+Number(i.qty||1), 0); }
    function updateCartBadge(){ const q = cartQty(); const b = $('#cartQty'); if (q>0){ b.textContent = q; b.classList.remove('hidden'); } else { b.classList.add('hidden'); } }
    function addToCart(item){ if (!isLogged()) return toast('Entre para usar o carrinho', false); const cart = loadCart(); const idx = cart.findIndex(x=> x.id===item.id); if (idx>=0) cart[idx].qty += 1; else cart.push({ id:item.id, name:item.name, price_cents:item.price_cents, image:item.image, qty:1 }); saveCart(cart); updateCartBadge(); toast('Adicionado ao carrinho'); }
    function removeFromCart(id){ const cart = loadCart().filter(x=> x.id!==id); saveCart(cart); updateCartBadge(); }
    function changeQty(id, delta){ const cart = loadCart(); const i = cart.findIndex(x=>x.id===id); if (i<0) return; cart[i].qty = Math.max(1, (cart[i].qty||1)+delta); saveCart(cart); updateCartBadge(); }
    function renderCart(){ const wrap = $('#cartItems'); if(!wrap) return; const cart = loadCart(); wrap.innerHTML = ''; let total = 0; cart.forEach(it=>{ const price = (Number(it.price_cents||0)/100); total += price * Number(it.qty||1); const row = document.createElement('div'); row.className = 'card p-3 flex items-center gap-3'; row.innerHTML = `<img src="${it.image||''}" class="w-16 h-16 object-cover rounded-lg border" alt=""><div class="flex-1"><div class="font-semibold">${it.name||'Cupcake'}</div><div class="text-sm text-gray-600">${currency(price)}</div></div><div class="flex items-center gap-2"><button class="btn btn-secondary" data-dec="${it.id}">-</button><span class="w-8 text-center">${it.qty||1}</span><button class="btn btn-secondary" data-inc="${it.id}">+</button><button class="btn btn-danger" data-rem="${it.id}">Remover</button></div>`; wrap.appendChild(row); }); $('#cartTotal').textContent = currency(total); $$('#cartItems [data-inc]').forEach(b=> b.onclick = ()=> changeQty(Number(b.getAttribute('data-inc')), +1)); $$('#cartItems [data-dec]').forEach(b=> b.onclick = ()=> changeQty(Number(b.getAttribute('data-dec')), -1)); $$('#cartItems [data-rem]').forEach(b=> b.onclick = ()=> removeFromCart(Number(b.getAttribute('data-rem')))); }

    async function parseJsonSafe(r){ const t = await r.text(); try{ return JSON.parse(t); } catch{ return { message: t || 'Erro' }; } }
    async function apiLogin(email, password){ const r = await fetch(`${getBase()}/api/auth/login`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ email, password }) }); const data = await parseJsonSafe(r); if(!r.ok) throw new Error(data.message||`Falha no login (${r.status})`); return data; }
    async function apiRegister(payload){ const r = await fetch(`${getBase()}/api/auth/register`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) }); const data = await parseJsonSafe(r); if(!r.ok) throw new Error(data.message||`Falha no cadastro (${r.status})`); return data; }
    async function apiGetMe(){ const r = await fetch(`${getBase()}/api/auth/me`, { headers: { ...authHeader() } }); const data = await parseJsonSafe(r); if(!r.ok) throw new Error(data.message||`Perfil (${r.status})`); return data; }
    async function apiUpdateMe(payload){ const r = await fetch(`${getBase()}/api/auth/me`, { method:'PUT', headers:{ 'Content-Type':'application/json', ...authHeader() }, body: JSON.stringify(payload) }); const data = await parseJsonSafe(r); if(!r.ok) throw new Error(data.message||`Atualizar perfil (${r.status})`); return data; }
    async function apiChangePassword({ current_password, new_password }){ const r = await fetch(`${getBase()}/api/auth/change-password`, { method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() }, body: JSON.stringify({ current_password, new_password }) }); if(!r.ok){ const d=await parseJsonSafe(r); throw new Error(d.message||`Alterar senha (${r.status})`);} return true; }
    async function apiDeleteMe(){ const r = await fetch(`${getBase()}/api/auth/me`, { method:'DELETE', headers:{ ...authHeader() } }); if(!r.ok){ const d=await parseJsonSafe(r); throw new Error(d.message||`Remover conta (${r.status})`);} return true; }
    async function apiList(){ const r = await fetch(`${getBase()}/api/cupcakes`); if(!r.ok) throw new Error(`Cupcakes (${r.status})`); return parseJsonSafe(r); }
    async function apiCreate({ name, description, price, stock, file }){ const fd = new FormData(); fd.append('nome', name); fd.append('descricao', description); fd.append('preco_cents', Math.round(Number(price)*100)); fd.append('estoque', Number(stock||0)); if (file) fd.append('image', file); const r = await fetch(`${getBase()}/api/admin/cupcakes`, { method:'POST', headers:{ ...authHeader() }, body: fd }); const data = await parseJsonSafe(r); if(!r.ok) throw new Error(data.message||`Criar cupcake (${r.status})`); return data; }
    async function apiDelete(id){ const r = await fetch(`${getBase()}/api/admin/cupcakes/${id}`, { method:'DELETE', headers:{ ...authHeader() } }); if(!r.ok) throw new Error(`Excluir (${r.status})`); return true; }
    async function apiCreateOrder({ items, payment_method, code }){ const r = await fetch(`${getBase()}/api/orders`, { method:'POST', headers: { 'Content-Type':'application/json', ...authHeader() }, body: JSON.stringify({ items, payment_method, code }) }); const data = await parseJsonSafe(r); if (!r.ok) throw new Error(data.message || `Pedido (${r.status})`); return data; }
    async function apiGetMyOrders(){ const r = await fetch(`${getBase()}/api/orders/my`, { headers: { ...authHeader() } }); const data = await parseJsonSafe(r); if(!r.ok) throw new Error(data.message||`Pedidos (${r.status})`); return data; }

    function renderSkeleton(count=6){ const grid = $('#grid'); grid.innerHTML = ''; for (let i=0;i<count;i++){ const card = document.createElement('div'); card.className = 'card'; card.innerHTML = `<div class="h-40 skeleton"></div><div class="p-4 space-y-2"><div class="h-4 w-3/4 skeleton rounded"></div><div class="h-3 w-1/2 skeleton rounded"></div><div class="h-8 w-24 skeleton rounded"></div></div>`; grid.appendChild(card); } }
    function normalize(item){ const imageRaw = item.image_url || item.imageUrl || item.image || item.image_path; return { id: item.id, name: item.nome || item.name, description: item.descricao || item.description || '', price_cents: item.preco_cents ?? Math.round(Number(item.price||0)*100), image: fullURL(imageRaw) }; }
    function renderList(items){ const grid = $('#grid'); grid.innerHTML = ''; $('#countChip').textContent = `${items.length} ${items.length===1?'item':'itens'}`; if (!items.length){ $('#empty').classList.remove('hidden'); return; } $('#empty').classList.add('hidden'); items.map(normalize).forEach((c) => { const el = document.createElement('article'); el.className = 'card flex flex-col'; el.innerHTML = `<img src="${c.image||''}" alt="${c.name||'Cupcake'}" class="w-full h-40 object-cover bg-gray-50"><div class="p-4 flex-1 flex flex-col gap-2"><h3 class="font-extrabold text-gray-900 leading-tight">${c.name||'‚Äî'}</h3><p class="text-sm text-gray-600 line-clamp-2">${c.description||''}</p><div class="mt-auto flex items-center justify-between"><span class="font-extrabold text-green-700">${currency((c.price_cents||0)/100)}</span><div class="flex gap-2">${isAdmin() ? `<button data-del="${c.id}" class="btn btn-danger text-sm">Excluir</button>` : ''}<button data-add="${c.id}" class="btn btn-primary text-sm">Adicionar</button></div></div></div>`; grid.appendChild(el); el.querySelector('[data-add]').onclick = ()=> addToCart(c); if (isAdmin()){ const del = el.querySelector('[data-del]'); if (del) del.onclick = async ()=>{ if (!confirm('Confirma excluir este cupcake?')) return; try { await apiDelete(c.id); toast('Cupcake exclu√≠do'); await load(); } catch(e){ toast(e.message||'Erro ao excluir', false); } }; } }); }

    async function load(){ try{ renderSkeleton(); const data = await apiList(); const arr = Array.isArray(data) ? data : (data.items || []); state.items = arr; applyFilter(); } catch(e){ toast(e.message||'Erro ao carregar cupcakes', false); } }
    function applyFilter(){ const q = $('#search').value.trim().toLowerCase(); const filtered = !q ? state.items : state.items.filter(x => { const n = (x.nome||x.name||'').toLowerCase(); const d = (x.descricao||x.description||'').toLowerCase(); return n.includes(q) || d.includes(q); }); state.filtered = filtered; renderList(filtered); }

    function genOrderCode(){ return 'CPT-' + Math.random().toString(36).slice(2,6).toUpperCase() + '-' + Date.now().toString(36).toUpperCase(); }
    function onlyDigits(s){ return String(s||'').replace(/\D+/g,''); }
    function luhn(card){ const s=onlyDigits(card); let sum=0,alt=false; for(let i=s.length-1;i>=0;i--){ let n=+s[i]; if(alt){ n*=2; if(n>9) n-=9; } sum+=n; alt=!alt; } return (sum%10)===0 && s.length>=13 && s.length<=19; }
    function validExpiry(mmYY){ const m = mmYY.match(/^\s*(\d{2})\s*\/\s*(\d{2})\s*$/); if(!m) return false; const mm=+m[1], yy=+m[2]; if(mm<1||mm>12) return false; const year=2000+yy; const now=new Date(); const lastDay=new Date(year,mm,0); return lastDay >= new Date(now.getFullYear(), now.getMonth(), 1); }
    function validCvc(cvc){ const d=onlyDigits(cvc); return d.length===3 || d.length===4; }
    function cartToOrderItems(){ const cart = loadCart(); return cart.map(i => ({ cupcake_id: Number(i.id), quantidade: Number(i.qty||1) })); }
    function openCheckout(){ if(!isLogged()) { toast('Entre para finalizar a compra', false); return; } const cart = loadCart(); const total = cart.reduce((s,i)=> s + (Number(i.price_cents||0)/100) * Number(i.qty||1), 0); if(!cart.length || total<=0){ toast('Carrinho vazio', false); return; } $('#paymentModal').showModal(); }
    async function openPix(){ const code = genOrderCode(); $('#pixCode').textContent = code; try { const items = cartToOrderItems(); if(!items.length) throw new Error('Carrinho vazio'); await apiCreateOrder({ items, payment_method: 'pix', code }); clearCart(); updateCartBadge(); $('#paymentModal').close(); $('#pixModal').showModal(); toast('Pedido criado (PIX)'); } catch(e){ toast(e.message || 'Erro ao criar pedido', false); } }
    function openCard(){ $('#paymentModal').close(); $('#cardModal').showModal(); }

    function setUpPaymentUI(){
      $('#btnCheckout').onclick = openCheckout;
      $('#payPix').onclick = openPix;
      $('#payCard').onclick = openCard;

      const ccName=$('#ccName'), ccNumber=$('#ccNumber'), ccExp=$('#ccExp'), ccCvc=$('#ccCvc'), btnFinish=$('#btnFinishCard'), cardError=$('#cardError');
      function onlyDigitsLocal(v){ return String(v||'').replace(/\D+/g,''); }
      function maskNumber(v){ const d=onlyDigitsLocal(v).slice(0,19); return d.replace(/(\d{4})(?=\d)/g,'$1 ').trim(); }
      function maskExp(v){ const d=onlyDigitsLocal(v).slice(0,4); if(d.length<=2) return d; return d.slice(0,2)+'/'+d.slice(2); }
      function validate(){ const ok=(ccName.value||'').trim().length>=3 && luhn(ccNumber.value) && validExpiry(ccExp.value) && validCvc(ccCvc.value); btnFinish.disabled=!ok; if(!ok){ cardError.classList.remove('hidden'); cardError.textContent='Verifique os dados do cart√£o.'; } else { cardError.classList.add('hidden'); } }
      $('#ccNumber').addEventListener('input', e=>{ e.target.value=maskNumber(e.target.value); validate(); });
      $('#ccExp').addEventListener('input', e=>{ e.target.value=maskExp(e.target.value); validate(); });
      $('#ccCvc').addEventListener('input', validate);
      $('#ccName').addEventListener('input', validate);

      $('#btnFinishCard').onclick = async ()=>{
        const btnFinish = $('#btnFinishCard');
        if(btnFinish.disabled) return;
        const code = genOrderCode();
        try {
          const items = cartToOrderItems();
          if(!items.length) throw new Error('Carrinho vazio');
          await apiCreateOrder({ items, payment_method: 'card', code });
          clearCart(); updateCartBadge();
          $('#cardModal').close();
          $('#successCode').textContent = code;
          $('#successModal').showModal();
          toast('Pedido criado (Cart√£o)');
        } catch(e) {
          toast(e.message || 'Erro ao criar pedido', false);
        }
      };
    }

    function safeName(u){ return u?.nome?.trim() || u?.email?.split('@')[0] || 'Usu√°rio'; }
    function toggleMenu(show){ const menu = $('#userMenu'); if (show) menu.classList.remove('hidden'); else menu.classList.add('hidden'); }

    function setAuthUI(){
      if (isLogged()){
        $('#openAuth').classList.add('hidden');
        $('#openRegister').classList.add('hidden');
        $('#btnLogout').classList.add('hidden');
        $('#userMenuWrap').classList.remove('hidden');
        $('#userMenuBtn').textContent = safeName(state.user);
        if (isAdmin()){
          $('#adminPanel').classList.remove('hidden');
          $('#openSettings').classList.remove('hidden');
        } else {
          $('#adminPanel').classList.add('hidden');
          $('#openSettings').classList.add('hidden');
        }
      } else {
        $('#openAuth').classList.remove('hidden');
        $('#openRegister').classList.remove('hidden');
        $('#btnLogout').classList.add('hidden');
        $('#userMenuWrap').classList.add('hidden');
        $('#adminPanel').classList.add('hidden');
        $('#openSettings').classList.add('hidden');
      }
      updateCartBadge();
      renderCart();
    }

    function renderOrdersList(list){
      const wrap = $('#ordersWrap');
      const empty = $('#ordersEmpty');
      wrap.innerHTML = '';
      if (!Array.isArray(list) || list.length === 0){
        empty.classList.remove('hidden');
        return;
      }
      empty.classList.add('hidden');

      list.forEach(o=>{
        const method = String(o.payment_method||'').toLowerCase()==='pix' ? '<span class="pill pill-pix">PIX</span>' : '<span class="pill pill-card">Cart√£o</span>';
        const created = o.created_at ? new Date(o.created_at).toLocaleString('pt-BR') : '';
        const total = currency((o.total_cents||0)/100);
        const items = Array.isArray(o.items)? o.items : [];
        const itemsHtml = items.map(it => {
          const p = currency((it.preco_unit_cents||0)/100);
          return `<div class="flex justify-between text-sm"><span class="muted">${it.nome} √ó ${it.quantidade}</span><span>${p}</span></div>`;
        }).join('') || '<div class="text-sm muted">Sem itens</div>';

        const card = document.createElement('div');
        card.className = 'card p-4';
        card.innerHTML = `
          <div class="flex flex-wrap items-center justify-between gap-2">
            <div class="font-bold">Pedido ${o.code || o.id}</div>
            <div class="flex items-center gap-2">${method}<span class="muted">${created}</span></div>
          </div>
          <div class="mt-3 space-y-1">${itemsHtml}</div>
          <div class="mt-3 text-right font-extrabold">${total}</div>
        `;
        wrap.appendChild(card);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      $('#openSettings').onclick = ()=> $('#settings').showModal();
      $('#apiBase').value = getBase();
      $('#btnSaveBase').onclick = ()=>{ setBase($('#apiBase').value || ''); toast('API Base URL salva'); };
      $('#btnPing').onclick = async ()=>{ try{ const r = await fetch(`${getBase()}/api/cupcakes`); toast(r.ok? 'Conex√£o OK' : `Resposta ${r.status}`, r.ok); } catch{ toast('Falha de conex√£o', false); } };

      $('#openAuth').onclick = ()=> $('#auth').showModal();
      $('#openRegister').onclick = ()=> $('#register').showModal();

      $('#userMenuBtn').onclick = (e)=>{ e.stopPropagation(); toggleMenu($('#userMenu').classList.contains('hidden')); };
      document.addEventListener('click', ()=> toggleMenu(false));

      $('#openProfile').onclick = async (e)=>{ e.stopPropagation(); toggleMenu(false);
        try{
          const me = await apiGetMe();
          $('#pfNome').value = me.nome || '';
          $('#pfTelefone').value = me.telefone || '';
          $('#pfEndereco').value = me.endereco || '';
          $('#profile').showModal();
        } catch(e){ toast(e.message, false); }
      };

      $('#openOrders').onclick = async (e)=>{
        e.stopPropagation(); toggleMenu(false);
        if (!isLogged()) { toast('Entre para ver seus pedidos', false); return; }
        try{
          const data = await apiGetMyOrders();
          const orders = Array.isArray(data?.orders) ? data.orders : (Array.isArray(data)? data : []);
          renderOrdersList(orders);
          $('#ordersModal').showModal();
        } catch(err){ toast(err.message || 'Erro ao carregar pedidos', false); }
      };

      $('#logoutFromMenu').onclick = ()=>{ localStorage.removeItem(STORAGE.token); localStorage.removeItem(STORAGE.user); state.token=null; state.user=null; setAuthUI(); toast('Sess√£o encerrada'); load(); };

      $('#doLogin').onclick = async ()=>{
        const email = $('#email').value.trim(); const password = $('#password').value; const err = $('#authError'); err.classList.add('hidden');
        try{
          const data = await apiLogin(email, password);
          state.token = data.token; state.user = data.user || null;
          localStorage.setItem(STORAGE.token, state.token);
          localStorage.setItem(STORAGE.user, JSON.stringify(state.user));
          $('#auth').close(); setAuthUI(); toast('Login realizado'); load();
        } catch(e){ err.textContent = e.message; err.classList.remove('hidden'); }
      };

      $('#doRegister').onclick = async ()=>{
        const payload = {
          email: $('#regEmail').value.trim(),
          password: $('#regPass').value,
          nome: $('#regNome').value.trim() || null,
          telefone: $('#regTelefone').value.trim() || null,
          endereco: $('#regEndereco').value.trim() || null
        };
        const err = $('#regError'); err.classList.add('hidden');
        try{
          const data = await apiRegister(payload);
          state.token = data.token; state.user = data.user || null;
          localStorage.setItem(STORAGE.token, state.token);
          localStorage.setItem(STORAGE.user, JSON.stringify(state.user));
          $('#register').close(); setAuthUI(); toast('Conta criado'); load();
        } catch(e){ err.textContent = e.message; err.classList.remove('hidden'); }
      };

      $('#btnLogout').onclick = ()=>{
        localStorage.removeItem(STORAGE.token);
        localStorage.removeItem(STORAGE.user);
        state.token = null; state.user = null;
        setAuthUI(); toast('Sess√£o encerrada'); load();
      };

      $('#btnSaveProfile').onclick = async ()=>{
        const err = $('#pfError'); err.classList.add('hidden');
        try{
          const payload = {
            nome: $('#pfNome').value.trim() || null,
            telefone: $('#pfTelefone').value.trim() || null,
            endereco: $('#pfEndereco').value.trim() || null
          };
          const me = await apiUpdateMe(payload);
          state.user = { ...state.user, ...me };
          localStorage.setItem(STORAGE.user, JSON.stringify(state.user));
          $('#userMenuBtn').textContent = safeName(state.user);
          $('#profile').close();
          toast('Perfil atualizado');
        } catch(e){ err.textContent = e.message; err.classList.remove('hidden'); }
      };

      $('#btnChangePassOpen').onclick = ()=> { $('#changePassModal').showModal(); };
      $('#btnChangePass').onclick = async ()=>{
        const cur = $('#pfCurPass').value || '';
        const n1  = $('#pfNewPass').value || '';
        const n2  = $('#pfNewPass2').value || '';
        const err = $('#cpError'); err.classList.add('hidden');
        if (!cur || !n1 || !n2){ err.textContent='Preencher todos os campos de senha'; err.classList.remove('hidden'); return; }
        if (n1.length < 6){ err.textContent='Nova senha deve ter ao menos 6 caracteres'; err.classList.remove('hidden'); return; }
        if (n1 !== n2){ err.textContent='Nova senha e confirma√ß√£o n√£o conferem'; err.classList.remove('hidden'); return; }
        try{
          await apiChangePassword({ current_password: cur, new_password: n1 });
          $('#pfCurPass').value = ''; $('#pfNewPass').value=''; $('#pfNewPass2').value='';
          $('#changePassModal').close(); $('#profile').close();
          toast('Senha alterada. Fa√ßa login novamente.');
          localStorage.removeItem(STORAGE.token);
          localStorage.removeItem(STORAGE.user);
          state.token = null; state.user = null;
          setAuthUI();
        } catch(e){ err.textContent = e.message; err.classList.remove('hidden'); }
      };

      $('#btnDeleteAccount').onclick = async ()=>{
        const err = $('#pfError'); err.classList.add('hidden');
        if (!confirm('Confirma remover sua conta? Esta a√ß√£o √© irrevers√≠vel.')) return;
        try{
          await apiDeleteMe();
          toast('Conta removida');
          localStorage.removeItem(STORAGE.token);
          localStorage.removeItem(STORAGE.user);
          localStorage.removeItem(cartKey());
          state.token = null; state.user = null;
          $('#profile').close();
          setAuthUI();
          load();
        } catch(e){ err.textContent = e.message; err.classList.remove('hidden'); }
      };

      $('#openCart').onclick = ()=>{ renderCart(); $('#cartModal').showModal(); };

      $('#search').addEventListener('input', applyFilter);
      $('#btnClear').onclick = ()=>{ $('#search').value=''; applyFilter(); };
      $('#btnRefresh').onclick = load;

      const drop = $('#drop'); const fileInput = $('#image'); const preview = $('#preview');
      drop?.addEventListener('click', ()=> fileInput.click());
      drop?.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('bg-gray-50'); });
      drop?.addEventListener('dragleave', ()=> drop.classList.remove('bg-gray-50'));
      drop?.addEventListener('drop', (e)=>{ e.preventDefault(); drop.classList.remove('bg-gray-50'); if (e.dataTransfer.files && e.dataTransfer.files[0]) { fileInput.files = e.dataTransfer.files; showPreview(fileInput.files[0]); } });
      fileInput?.addEventListener('change', (e)=>{ if (e.target.files[0]) showPreview(e.target.files[0]); });
      function showPreview(file){ const ok = /image\/(png|jpe?g)/i.test(file.type); if(!ok){ toast('Apenas PNG/JPEG', false); fileInput.value=''; preview.classList.add('hidden'); return; } const url = URL.createObjectURL(file); preview.src = url; preview.classList.remove('hidden'); }

      $('#formCreate')?.addEventListener('submit', async (e)=>{
        e.preventDefault();
        if (!isLogged() || !isAdmin()) return toast('A√ß√£o restrita a administradores', false);
        const name = $('#name').value.trim();
        const description = $('#description').value.trim();
        const price = $('#price').value;
        const stock = $('#stock').value;
        const file = $('#image').files[0];
        try{
          await apiCreate({ name, description, price, stock, file });
          e.target.reset(); $('#preview').classList.add('hidden');
          toast('Cupcake cadastrado'); load();
        }catch(err){ toast(err.message||'Erro ao cadastrar', false); }
      });

      setUpPaymentUI();
      setAuthUI(); load();
    });
  </script>
</body>
</html>
